<!DOCTYPE html><html>
<head>
<title></title>
<style type="text/css">
<!--
.xflip {
    -moz-transform: scaleX(-1);
    -webkit-transform: scaleX(-1);
    -o-transform: scaleX(-1);
    transform: scaleX(-1);
    filter: fliph;
}
.yflip {
    -moz-transform: scaleY(-1);
    -webkit-transform: scaleY(-1);
    -o-transform: scaleY(-1);
    transform: scaleY(-1);
    filter: flipv;
}
.xyflip {
    -moz-transform: scaleX(-1) scaleY(-1);
    -webkit-transform: scaleX(-1) scaleY(-1);
    -o-transform: scaleX(-1) scaleY(-1);
    transform: scaleX(-1) scaleY(-1);
    filter: fliph + flipv;
}
-->
</style>
</head>
<body>
<a name=1></a>Защищено:&#160;&#160;<br/>
&#34;__&#34;_____________2017&#160;г&#160;&#160;&#160;&#160;<br/>
Отчет&#160;по&#160;лабораторной&#160;работе&#160;№&#160;2-6&#160;по&#160;курсу<br/>
БКИТ<br/>
ИСПОЛНИТЕЛЬ:&#160;студент&#160;группы&#160;ИУ5-33<br/>
&#160;_____________________&#160;(подпись)<br/>
Нечаев&#160;А.А.&#160;&#34;__&#34;_____________2017&#160;г.<br/>
Москва,&#160;МГТУ&#160;—&#160;2017<br/>
<hr/>
<a name=2></a>Оглавление<br/>
<a href="LAB2-6_Reports.html#3">Ц</a><br/>
<a href="LAB2-6_Reports.html#3">&#160;&#160;ель&#160;выполнения&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a><br/>
<a href="LAB2-6_Reports.html#3">.......................................................................................................................&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..3&#160;&#160;</a><br/>
<a href="LAB2-6_Reports.html#4">В&#160;ыполнена&#160;работа&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a><br/>
<a href="LAB2-6_Reports.html#4">...................................................................................................................................&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;.4&#160;</a><br/>
<a href="LAB2-6_Reports.html#5">&#160;C</a><br/>
<a href="LAB2-6_Reports.html#5">&#160;&#160;H_ESP_SN&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a><br/>
<a href="LAB2-6_Reports.html#5">.........................................................................................................................................&#160;&#160;..&#160;&#160;..&#160;&#160;..&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;.5&#160;</a><br/>
<a href="LAB2-6_Reports.html#9">&#160; &#160;С</a><br/>
<a href="LAB2-6_Reports.html#9">&#160;&#160;бор&#160;данных&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a><br/>
<a href="LAB2-6_Reports.html#9">.............................................................................................................................&#160;&#160;..&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;&#160;..&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;.9&#160;</a><br/>
<a href="LAB2-6_Reports.html#10">&#160; &#160;П</a><br/>
<a href="LAB2-6_Reports.html#10">&#160;&#160;ередача&#160;данных&#160;на&#160;удалённый&#160;сервис&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a><br/>
<a href="LAB2-6_Reports.html#10">..............................................................................&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;..&#160;..&#160;.&#160;&#160;..1&#160;0&#160;</a><br/>
<a href="LAB2-6_Reports.html#11">&#160; &#160;Л</a><br/>
<a href="LAB2-6_Reports.html#11">&#160;&#160;окальное&#160;взаимодействие&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a><br/>
<a href="LAB2-6_Reports.html#11">......................................................................................................................&#160;&#160;..&#160;.11&#160;</a><br/>
<a href="LAB2-6_Reports.html#14">&#160;D</a><br/>
<a href="LAB2-6_Reports.html#14">&#160;&#160;ISP_ESP_SN&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a><br/>
<a href="LAB2-6_Reports.html#14">..........................................................................................................................................&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;.14&#160;</a><br/>
<a href="LAB2-6_Reports.html#16">&#160;П</a><br/>
<a href="LAB2-6_Reports.html#16">&#160;&#160;еределка&#160;FBI&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a><br/>
<a href="LAB2-6_Reports.html#16">.......................................................................................................................................&#160;&#160;..&#160;..&#160;.&#160;&#160;..&#160;&#160;..&#160;.15&#160;</a><br/>
<a href="LAB2-6_Reports.html#17">&#160;О</a><br/>
<a href="LAB2-6_Reports.html#17">&#160;&#160;бъединение&#160;CH_ESP_SN и&#160;DISP_ESP_SN&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a><br/>
<a href="LAB2-6_Reports.html#17">...............................................................................................&#160;..&#160;.&#160;&#160;..&#160;&#160;..1&#160;6&#160;</a><br/>
<hr/>
<a name=3></a><b>Цель&#160;выполнения</b><br/>
Разработать&#160;часть&#160;системы&#160;умного дома.<br/>
<b>Блок&#160;схема&#160;проэкта&#160;системы:</b><br/>
Система&#160;&#160;&#160;должна&#160;&#160;&#160;иметь&#160;&#160;&#160;возможность&#160;&#160;&#160;работать&#160;&#160;&#160;как&#160;&#160;&#160;в&#160;&#160;&#160;полном&#160;&#160;&#160;(централизованном)&#160;&#160;&#160;режиме,<br/>так&#160;и&#160;в&#160;(урезанном)&#160;режиме&#160;в&#160;прямого взаимодействия.<br/>
Каждое&#160;устройство с&#160;мощностью&#160;более&#160;2ВА&#160;должно иметь&#160;отдельное&#160;подключение&#160;к&#160;сети&#160;питания.<br/>
Как&#160;&#160;&#160;основное&#160;&#160;&#160;связующие&#160;&#160;&#160;звено&#160;&#160;&#160;системы&#160;&#160;&#160;в&#160;&#160;&#160;полном&#160;&#160;&#160;режиме&#160;&#160;&#160;должна&#160;&#160;&#160;выступать&#160;&#160;&#160;ГПИУШ(Главная<br/>Питающая&#160;и&#160;Управляющая&#160;Шина)&#160;которая&#160;должна&#160;состоять&#160;из:&#160;<br/>
1.&#160;GND&#160;-&#160;Общая&#160;земля&#160;питания<br/>
2.&#160;Vmain&#160;–&#160;Главное&#160;напряжение&#160;питания&#160;(Для&#160;централизованного питания&#160;маломощных&#160;устр)<br/>
3.&#160;Vres –&#160;Резервируемое&#160;питание&#160;(Для&#160;главного и&#160;резервного питания&#160;жизнено важных&#160;устройств)<br/>
4.&#160;Alarm&#160;-Тревожный&#160;сигнал&#160;(Притянут&#160;к&#160;Vres&#160;через&#160;1ком&#160;резистор&#160;и&#160;шунтирующие&#160;конденсаторы)<br/>
резервная&#160;&#160;&#160;сигнальная&#160;&#160;&#160;линяя&#160;&#160;&#160;тревоги&#160;&#160;&#160;(для&#160;&#160;&#160;поднятия&#160;&#160;&#160;тревоги&#160;&#160;&#160;подтягивается&#160;&#160;&#160;к&#160;&#160;GND)<br/>Напр&#160;&lt;=&#160;1/3(Vres)&#160;тревога.<br/>
5.&#160;RS485&#160;A&#160;линии&#160;обмена&#160;данными&#160;(прокладываются&#160;отдельной&#160;витой&#160;парой)<br/>
6.&#160;RS485&#160;B<br/>
Для&#160;Vres&#160;и&#160;Vmain&#160;допустимым&#160;считается&#160;напряжение&#160;в&#160;пределах&#160;от&#160;11&#160;до 30&#160;Вольт.<br/>
С&#160;возможными&#160;кратковременными&#160;&gt;1мин&#160;&#160;Vmin=&#160;9В&#160;Vmax=&#160;40В<br/>
<hr/>
<a name=4></a>Также&#160;к устройствам&#160;KUIP,&#160;CH_ESP_SN,&#160;DISP_ESP_SN&#160;могут&#160;быть&#160;подключены&#160;сторонние&#160;устройства&#160;и&#160;<br/>системы&#160;сигнализации.<br/>
В&#160;случае&#160;обнаружения&#160;посадки&#160;на&#160;линии&#160;Alarm,&#160;все&#160;устройства&#160;должны&#160;прервать&#160;работу&#160;с&#160;RS485&#160;и&#160;<br/>ожидать&#160;запроса&#160;от&#160;ведущего&#160;KUIP,&#160;в&#160;течение&#160;20&#160;сек,&#160;и&#160;при&#160;его поступлении&#160;ответить&#160;эхо&#160;ответом,&#160;либо&#160;<br/>причиной&#160;вызова&#160;тревоги.&#160;В&#160;случае&#160;отсутствия&#160;запроса&#160;как по&#160;RS485&#160;так&#160;и&#160;по&#160;Wi-Fi&#160;линиям&#160;устройства&#160;<br/>вызвавшая&#160;срабатывание&#160;должна&#160;самостоятельно опросить&#160;другие&#160;устройства.&#160;В&#160;случае&#160;отсутствия&#160;<br/>запросов&#160;в&#160;течении&#160;20&#160;сек,&#160;либо сразу&#160;при&#160;пропадании&#160;Vres&#160;все&#160;системы&#160;переходят&#160;в&#160;автономный&#160;<br/>режим&#160;при&#160;этом&#160;включаются&#160;все&#160;системы&#160;аварийного освещения,&#160;а&#160;в&#160;случае&#160;пропадания&#160;питающего&#160;<br/>напряжении&#160;в&#160;сети&#160;220в&#160;и&#160;оповещения.<br/>
<b>Выполнена&#160;работа</b><br/>
Были&#160;разработаны&#160;и&#160;изготовлены&#160;устройства:<br/>
•<br/>
<b>ch_esp_sn</b>&#160;-&#160;для&#160;сбора&#160;данных&#160;с&#160;датчиков&#160;(Устройство снятия&#160;показаний&#160;с&#160;датчиков)<br/>
•<br/>
<b>disp_esp_sn</b>&#160;-&#160;для&#160;отображения&#160;данных&#160;в&#160;реальном&#160;времени,&#160;сбора&#160;данных,&#160;и&#160;исполнения&#160;<br/>команд&#160;(Устройство отображения&#160;информации)<br/>
Также&#160;для&#160;отображения&#160;данных&#160;вместе&#160;с&#160;показом&#160;слайд&#160;шоу&#160;была&#160;модифицирована&#160;консольная&#160;<br/>программа&#160;fbi&#160;(Frame&#160;Buffer&#160;Imageviewer),&#160;теперь&#160;вместо статусной&#160;строки&#160;отображаются&#160;данные&#160;с&#160;<br/>устройства&#160;ch_esp_sn&#160;в&#160;реальном&#160;времени.<br/>
<hr/>
<a name=5></a>CH_ESP_SN<br/>
По&#160;сути&#160;это устройство сбора&#160;данных&#160;датчиков&#160;и&#160;их&#160;первичной&#160;обработки.<br/>
Состоит&#160;данное&#160;устройство на&#160;данный&#160;момент&#160;из&#160;WIFI&#160;модуля&#160;(ESP8266)&#160;со встроенным&#160;МК&#160;и&#160;<br/>запущенной&#160;ОС&#160;реального&#160;времени&#160;на&#160;нём,&#160;и&#160;AVR&#160;микроконтроллера&#160;ATmega328p-pu&#160;подключенным&#160;к&#160;<br/>нему&#160;по средствам&#160;SPI&#160;и&#160;UART&#160;интерфейсов(далее&#160;планируется&#160;оставить&#160;только&#160;SPI&#160;связь),&#160;а&#160;также&#160;<br/>периферийных&#160;устройств.<br/>
SPI&#160;интерфейс&#160;используется&#160;сейчас&#160;только&#160;для&#160;перепрошивки&#160;МК.<br/>
Основной&#160;обмен&#160;данными&#160;происходить&#160;по средствам&#160;UART&#160;интерфейса.<br/>
Для&#160;разработки&#160;всех&#160;прошивок&#160;используется&#160;набор&#160;библиотек из&#160;Arduino SDK,&#160;его адаптация&#160;под&#160;<br/>ESP8266.&#160;Данный&#160;вариант&#160;был&#160;выбран&#160;ввиду&#160;его простоты&#160;и&#160;достаточной&#160;быстроты&#160;для&#160;поставленной&#160;<br/>задачи.<br/>
<i>Блок&#160;схема&#160;устройства</i><br/>
На&#160;данный&#160;момент&#160;на&#160;устройстве&#160;установлены&#160;следующие&#160;датчики:<br/>
•<br/>
DHT-21&#160;-&#160;Влажность&#160;и&#160;температура<br/>
•<br/>
BH1750&#160;–&#160;Освещённость&#160;I2C<br/>
•<br/>
BMP280&#160;–&#160;Давление&#160;I2C<br/>
•<br/>
MQ-7&#160;и&#160;MQ-9&#160;Угарный&#160;и&#160;Горючий&#160;газы&#160;(аналоговые)<br/>
<hr/>
<a name=6></a><img src="LAB2-6_Report-6_1.png"/><br/>
<img src="LAB2-6_Report-6_2.jpg"/><br/>
Для&#160;обеспечения&#160;требуемого&#160;режима&#160;питания&#160;датчиков&#160;газа&#160;90&#160;сек 1,45В&#160;и&#160;60&#160;сек 5В&#160;была&#160;разработана&#160;<br/>схема&#160;управления&#160;преобразователя&#160;напряжения&#160;на&#160;основе&#160;модуля&#160;kis-3r33,&#160;2&#160;подстроечных&#160;резисторов<br/>и&#160;герконового реле&#160;переключающего их&#160;по команде&#160;МК.<br/>
<i>Принципиальная&#160;схема&#160;модуля&#160;питания&#160;аналоговых&#160;датчиков&#160;газа.</i><br/>
<i>Фото&#160;готового&#160;модуля</i><br/>
<a href="https://db.a1mc.ru/%D1%83%D0%BC-%D0%BD%D0%B0%D0%BF%D1%80%D1%8F%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA%D0%BE%D0%B2-%D1%81%D0%B5%D1%80%D0%B8%D0%B8-mq-%D1%81-%D0%BF%D0%BE/">Более&#160;подробная&#160;информация</a><br/>
<hr/>
<a name=7></a><img src="LAB2-6_Report-7_1.png"/><br/>
<img src="LAB2-6_Report-7_2.jpg"/><br/>
Для&#160;питания&#160;всего устройства&#160;был&#160;разработан&#160;модуль&#160;преобразователя&#160;напряжения&#160;на&#160;основе&#160;ШИМ&#160;<br/>контроллера&#160;MC34063,&#160;он&#160;был&#160;совмещён&#160;с&#160;преобразователем&#160;интерфейсов&#160;RS485-UART.<br/>
<i>Принципиальная&#160;схема&#160;модуля</i><br/>
<i>Относительно&#160;новая&#160;версия&#160;преобразователя.</i><br/>
<hr/>
<a name=8></a><img src="LAB2-6_Report-8_1.jpg"/><br/>
<img src="LAB2-6_Report-8_2.png"/><br/>
<i>Одна&#160;из&#160;первых&#160;версий,&#160;работает&#160;в&#160;составе&#160;ch_esp_sn&#160;по&#160;сей&#160;день&#160;(на&#160;выходе&#160;<br/>установлен&#160;Д815В)</i><br/>
<i>Разводка&#160;последней&#160;версии&#160;платы</i><br/>
<hr/>
<a name=9></a>Сбор&#160;данных<br/>
Опрос&#160;датчиков&#160;производится&#160;при&#160;помощи&#160;их&#160;опроса&#160;через&#160;равные&#160;промежутки&#160;времени&#160;<br/>микроконтроллером,&#160;далее&#160;МК.<br/>
При&#160;этом&#160;предусмотрена&#160;и&#160;используется&#160;возможность&#160;опроса&#160;с&#160;двойным&#160;и&#160;более&#160;интервалом&#160;(для&#160;<br/>датчиков&#160;с&#160;медленным&#160;обновлением&#160;показаний).<br/>
Для&#160;уменьшения&#160;воздействия&#160;внешних&#160;погрешностей&#160;используется&#160;двухуровневая&#160;система&#160;<br/>усреднения.<br/>
1.&#160;Подсчёт&#160;среднего арифметического за&#160;каждые&#160;30&#160;сек работы.<br/>
2.&#160;Плавающие&#160;средние&#160;(данные&#160;полученные&#160;после&#160;1-ого пункта&#160;заносятся&#160;в&#160;массив&#160;рассчитанный&#160;<br/>
на&#160;~7мин&#160;где&#160;индекс&#160;прибавляется&#160;каждые&#160;30&#160;секунд&#160;,&#160;а&#160;в&#160;случае&#160;достижения&#160;максимума&#160;<br/>сбрасывается&#160;в&#160;ноль)<br/>
При&#160;запросе&#160;данных&#160;у&#160;МК,&#160;производится&#160;получение&#160;арифметического среднего массива&#160;полученного 2&#160;<br/>пунктом,&#160;после&#160;чего данные&#160;передаются&#160;с&#160;помощью&#160;протокола&#160;A1&#160;DSP&#160;на&#160;ESP8622&#160;где&#160;происходит&#160;их&#160;<br/>дальнейшая&#160;обработка.<br/>
Также&#160;выполнен&#160;алгоритм&#160;переключения&#160;напряжения&#160;на&#160;датчиках&#160;газа,&#160;и&#160;раздельный&#160;сбор&#160;данных&#160;с&#160;<br/>них.<br/>
При&#160;этом,&#160;на&#160;данный&#160;момент&#160;ESP8266&#160;занимается&#160;только&#160;расчётом&#160;значений&#160;ppm&#160;для&#160;датчиков&#160;газа&#160;и&#160;<br/>их&#160;подстройкой.<br/>
Система&#160;обработки&#160;данных&#160;с&#160;датчиков&#160;газа&#160;основывается&#160;на&#160;вольном&#160;переносе&#160;библиотеки&#160;TroykaMQ,&#160;<br/>и&#160;для&#160;расчётов&#160;используются&#160;константы&#160;взятые&#160;из&#160;неё&#160;же.<br/>
Это&#160;было сделано ввиду&#160;невозможности&#160;калибровки&#160;датчиков&#160;в&#160;домашних&#160;условиях,&#160;и&#160;обеспечивает&#160;<br/>хотя&#160;бы&#160;приблизительные&#160;к реальности&#160;данные.<br/>
Кроме&#160;этого МК&#160;выполняет&#160;контроль&#160;напряжения&#160;преобразователя&#160;и&#160;в&#160;случае&#160;его выходов&#160;за&#160;<br/>допустимые&#160;значения&#160;выключает&#160;и&#160;передаёт&#160;данные&#160;об&#160;этом&#160;ESP(косвенно 0В&#160;на&#160;выходе&#160;<br/>преобразователя&#160;при&#160;обоих&#160;режимах)<br/>
<hr/>
<a name=10></a><img src="LAB2-6_Report-10_1.png"/><br/>
Передача&#160;данных&#160;на&#160;удалённый&#160;сервис<br/>
Устройство поддерживает&#160;передачу&#160;данных&#160;на&#160;сервис&#160;народного&#160;мониторинга<a href="http://narodmon.ru/">&#160;narodmon.ru,</a>&#160;используя&#160;<br/>их&#160;API.&#160;При&#160;этом&#160;передача&#160;выполняется&#160;каждые&#160;5&#160;мин,&#160;для&#160;этого используется&#160;библиотека&#160;Ticker&#160;<br/>которая&#160;позволяет&#160;задать&#160;функцию&#160;которая&#160;выполняется&#160;с&#160;разрывом&#160;в&#160;указанной&#160;интервал&#160;времени.&#160;&#160;&#160; &#160;<br/>В&#160;данном&#160;случае&#160;функция&#160;не&#160;вызывает&#160;отправку&#160;данных&#160;напрямую&#160;а&#160;использует&#160;байтовую&#160;переменную<br/>в&#160;качестве&#160;флага&#160;который&#160;обрабатывается&#160;в&#160;главном&#160;цикле&#160;вызывая&#160;формирование&#160;пакета&#160;и&#160;отправку&#160;<br/>данных.&#160;Такая&#160;система&#160;позволяет&#160;контролировать&#160;процесс&#160;отправки&#160;и&#160;избежать&#160;повторную&#160;попытку&#160;<br/>отправки&#160;пока&#160;вызванная&#160;ранее&#160;ещё&#160;не&#160;закончена.&#160;При&#160;считывании&#160;флага&#160;проверяются&#160;текущие&#160;<br/>значение&#160;других&#160;флагов,&#160;и&#160;в&#160;случае&#160;отсутствия&#160;запрещающих.<br/>
После&#160;чего управление&#160;передаётся&#160;функции&#160;отправки&#160;данных.&#160;Та&#160;в&#160;свою&#160;очередь&#160;выполняет&#160;<br/>формирование&#160;пакета&#160;для&#160;отправки.&#160;После&#160;чего открывается&#160;сокет&#160;и&#160;выполняется&#160;соединение&#160;с&#160;<br/>сервером&#160;narodmon.ru&#160;по&#160;порту&#160;8283,&#160;в&#160;случае&#160;ошибки&#160;функция&#160;возвращает&#160;код&#160;ошибки(false).&#160;В&#160;случае<br/>успешного соединения&#160;выполняется&#160;формирование&#160;пакета,&#160;на&#160;основе&#160;данных&#160;находящихся&#160;в&#160;<br/>глобальных&#160;переменных.&#160;После&#160;чего&#160;выполняется&#160;отправка&#160;сформированного пакета,&#160;далее&#160;&#160;<br/>выполняется&#160;ожидание&#160;ответа&#160;сервера&#160;в&#160;течении&#160;1,2&#160;секунды.&#160;После&#160;этого в&#160;случае&#160;получения&#160;ответа&#160;<br/>выполняется&#160;его&#160;обработка,&#160;так если&#160;сервер&#160;отвечает&#160;«OK»,&#160;или&#160;первый&#160;символ&#160;является&#160;#(получена&#160;<br/>удалённая&#160;команда,&#160;в&#160;данном&#160;случае&#160;игнорируется),&#160;либо ответ&#160;начинается&#160;с&#160;INTERVAL&#160;(слишком&#160;<br/>маленькая&#160;задержка&#160;после&#160;предыдущей&#160;передачи&#160;данных)&#160;&#160;функция&#160;завершается&#160;с&#160;успешным&#160;кодом&#160;<br/>(true).&#160;В&#160;случае&#160;не&#160;получения&#160;ответа,&#160;либо невозможности&#160;опознать&#160;ответ,&#160;функция&#160;возвращает&#160;<br/>ошибку(false).&#160;<br/>
После&#160;выхода&#160;из&#160;функции&#160;выполняется&#160;обработка&#160;кода&#160;возврата,&#160;в&#160;случае&#160;успешного кода&#160;значение&#160;<br/>флага&#160;обновляется&#160;и&#160;управление&#160;передается&#160;главному&#160;циклу.&#160;А&#160;в&#160;случае&#160;возврата&#160;кода&#160;ошибки&#160;<br/>устанавливается&#160;флаг повторной&#160;отправки,&#160;которая&#160;производится&#160;через&#160;1&#160;минуту&#160;после&#160;очередного&#160;<br/>считывания&#160;данных&#160;датчиков.&#160;Также&#160;увеличивается&#160;на&#160;один&#160;значения&#160;счётчика&#160;ошибок.<br/>
Результатом&#160;выполнения&#160;всех&#160;этих&#160;действий<br/>данные&#160;отправляются&#160;на&#160;сайт&#160;народного<br/>мониторинга&#160;где&#160;их&#160;можно просмотреть&#160;по<br/>ссылки:<a href="https://narodmon.ru/41">&#160;https://narodmon.ru/41.</a><br/>
Пример&#160;отправленного пакета:<br/>
<b>2018-01-09&#160;03:13:20&#160;</b>46.39.33.55&#160;TCP<br/>#A0-20-A6-16-77-A5#_v1.3.2<br/>#FHED#26728#Free&#160;ram&#160;in&#160;byte<br/>#MVC#5.12<br/>#MTMP#10.48<br/>#BTMP#11.80<br/>#BPRE#749.02<br/>#DTMP#-2.23<br/>#DHUM#100.00<br/>#LUX#0.00<br/>#MQ7#1#MQ7&#160;CO&#160;ppm<br/>#MQ9#4#MQ9&#160;CO&#160;ppm<br/>#MQ9L#7#MQ9&#160;LPG&#160;ppm<br/>#VIN#11.45<br/>##<br/>
<i>Данные&#160;отображаемые&#160;на&#160;сайте&#160;народного&#160;<br/>мониторинга</i><br/>
<hr/>
<a name=11></a>Локальное&#160;взаимодействие<br/>
Для&#160;локального взаимодействия&#160;на&#160;устройстве&#160;предусмотрены&#160;несколько&#160;интерфейсов:<br/>
•<br/>
GET&#160;запросы&#160;для&#160;изменения&#160;настроек и&#160;выполнения&#160;команд&#160;(на&#160;данный&#160;момент&#160;без&#160;автор.)<br/>
•<br/>
A1_DSP&#160;(Data&#160;in&#160;String&#160;Protocol)&#160;Протокол&#160;получения&#160;показаний&#160;в&#160;виде&#160;ASCII&#160;строки,&#160;<br/>используется&#160;как для&#160;внутреннего&#160;обмена&#160;с&#160;МК,&#160;так и&#160;для&#160;выдачи&#160;данных&#160;по запросу&#160;из&#160;<br/>локальной&#160;сети.&#160;URL&#160;/a1pr&#160;но используется&#160;только&#160;для&#160;считывания&#160;данных.<br/>
•<br/>
XML&#160;генерируемый&#160;по&#160;шаблону,&#160;используется&#160;только&#160;для&#160;считывания&#160;данных.<br/>
<b>A1_DSP&#160;(Data&#160;in String&#160;Protocol)<br/></b>Был&#160;разработан&#160;как простой&#160;протокол&#160;для&#160;обмена&#160;данными&#160;между&#160;устройствами&#160;в&#160;ЛВС&#160;и&#160;внутри&#160;<br/>одного устройства,&#160;это&#160;было&#160;сделано для&#160;избежания&#160;проблем&#160;совместимости&#160;ввиду&#160;разных&#160;размеров&#160;<br/>переменных&#160;на&#160;разных&#160;устройствах.<br/>
A1_DSP&#160;состоит&#160;из&#160;строки&#160;с&#160;парами&#160;(название:данные)&#160;оканчивающийся&#160;знаком&#160;«;»<br/>Где&#160;разделителями&#160;между&#160;парами&#160;являются&#160;пробелы.<br/>Сама&#160;пара&#160;состоит&#160;из&#160;названия&#160;(используются&#160;строго&#160;заглавными&#160;латинские&#160;буквы),<br/>&#160;и&#160;данных&#160;в&#160;виде&#160;числа&#160;(целого,&#160;или&#160;с&#160;плавающий&#160;точкой).<br/>&#160;<br/>NAME1:123.02&#160;NAME2:321.08;<br/>
На&#160;выходе&#160;требуется&#160;получить&#160;либо парные&#160;массивы&#160;(mas_name[i]&#160;mas_d[i],&#160;где&#160;i&#160;порядковый&#160;номер)<br/>&#160;либо ассоциативного массива&#160;по (типу&#160;map&#160;в&#160;c++)&#160;mas[NAME1]<br/>
Пример&#160;строки:<br/>MQV:1.42&#160;VMQ1:0.00&#160;VMQ2:0.07&#160;VIN:11.77&#160;MCVCC:5.00&#160;MCTMP:13.62&#160;LUX:279.00&#160;DHUM:68.43&#160;<br/>DTMP:11.23&#160;BPRE:774.10&#160;BTMP:22.02&#160;RDY=1;<br/>
MQV:1.42&#160; &#160;&#160;//Напряжение&#160;датчиков&#160;MQ<br/>VMQ1:0.00&#160; //Выходное&#160;напр&#160;датчика&#160;1<br/>VMQ2:0.07&#160; //Выходное&#160;напр&#160;датчика&#160;2<br/>VIN:11.77&#160;&#160; //Входное&#160;напряжение<br/>MCVCC:5.00&#160; //Напряжение&#160;на&#160;шине&#160;5В&#160;(atmega328)<br/>MCTMP:13.62&#160;//Температура&#160;(atmega328)<br/>LUX:279.00&#160;&#160;//Освещённость<br/>DHUM:68.43&#160; //Влажность&#160;датчика&#160;(DHT21)<br/>DTMP:11.23&#160; //Температура&#160;датчика&#160;(DHT21)<br/>BPRE:774.10&#160;//Давление&#160;(BMP180)<br/>BTMP:22.02&#160; //Температура&#160;датчика&#160;(BMP180)<br/>RDY:1&#160; &#160;&#160;&#160; &#160;//Усреднённые&#160;данные&#160;1-готовы&#160;0-нет<br/>
<hr/>
<a name=12></a><b>Пример&#160;сгенерированного&#160;XML&#160;файла</b><br/>
&lt;?xml&#160;version=&#34;1.0&#34;&#160;encoding=&#34;utf-8&#34;?&gt;<br/>&lt;esp&gt;<br/>&#160;&lt;fw&gt;<br/>&#160; &lt;b_time&gt;04:19:10&lt;/b_time&gt;<br/>&#160; &lt;b_date&gt;Jan&#160;&#160;2&#160;2018&lt;/b_date&gt;<br/>&#160; &lt;ver&gt;132&lt;/ver&gt;<br/>&#160;&lt;/fw&gt;<br/>&#160;&lt;status&gt;<br/>&#160; &lt;esp_vcc&gt;3.074000&lt;/esp_vcc&gt;<br/>&#160; &lt;mc_vcc&gt;5.120000&lt;/mc_vcc&gt;<br/>&#160; &lt;mc_tmp&gt;10.770000&lt;/mc_tmp&gt;<br/>&#160; &lt;data_recived&gt;1&lt;/data_recived&gt;<br/>&#160; &lt;data_redy&gt;1.000000&lt;/data_redy&gt;<br/>&#160;&lt;/status&gt;<br/>&#160;&lt;sensors&gt;<br/>&#160; &lt;bmp_r&gt;1&lt;/bmp_r&gt;<br/>&#160; &lt;bmp&gt;<br/>&#160; &#160;&lt;temp&gt;11.890000&lt;/temp&gt;<br/>&#160; &#160;&lt;pre&gt;748.890015&lt;/pre&gt;<br/>&#160; &lt;/bmp&gt;<br/>&#160; &lt;dht_r&gt;1&lt;/dht_r&gt;<br/>&#160; &lt;dht&gt;<br/>&#160; &#160;&lt;temp&gt;-2.350000&lt;/temp&gt;<br/>&#160; &#160;&lt;hum&gt;100.000000&lt;/hum&gt;<br/>&#160; &lt;/dht&gt;<br/>&#160; &lt;lux_r&gt;1&lt;/lux_r&gt;<br/>&#160; &lt;lux&gt;0.000000&lt;/lux&gt;<br/>&#160; &lt;else_r&gt;1.000000&lt;/else_r&gt;<br/>&#160; &lt;else&gt;<br/>&#160; &#160;&lt;mq7co&gt;9&lt;/mq7co&gt;<br/>&#160; &#160;&lt;mq9co&gt;5&lt;/mq9co&gt;<br/>&#160; &#160;&lt;mq9LPG&gt;8&lt;/mq9LPG&gt;<br/>&#160; &#160;&lt;vin&gt;11.440000&lt;/vin&gt;<br/>&#160; &#160;&lt;mqv&gt;1.430000&lt;/mqv&gt;<br/>&#160; &#160;&lt;mqv5&gt;5.010000&lt;/mqv5&gt;<br/>&#160; &#160;&lt;mq7&gt;0.050000&lt;/mq7&gt;<br/>&#160; &#160;&lt;mq9&gt;0.000000&lt;/mq9&gt;<br/>&#160; &#160;&lt;mq9_5&gt;0.760000&lt;/mq9_5&gt;<br/>&#160; &lt;/else&gt;<br/>&#160;&lt;/sensors&gt;<br/>&lt;/esp&gt;<br/>
<hr/>
<a name=13></a><b>Возможные&#160;GET&#160;запросы:<br/></b>/&#160;<br/>
&#160; Вывод&#160;html&#160;страницы&#160;с&#160;ссылками&#160;на&#160;элементы&#160;управления&#160;и&#160;инфо страниц.<br/>
/update&#160;&#160;Обновление&#160;прошивки&#160;по&#160;воздуху&#160;OTA,&#160;через&#160;POST&#160;(type='file'&#160;name='update')<br/>
/online_update&#160;Обновление&#160;прошивки&#160;с&#160;сервера.<br/>
/config.json&#160;Скачивание&#160;текущего конфигурационного файла.<br/>
/xml.xml&#160;Получение&#160;данных&#160;датчиков&#160;в&#160;виде&#160;xml&#160;файла.<br/>
/a1pr&#160;Получение&#160;данных&#160;датчиков&#160;о&#160;протоколу&#160;A1&#160;DSP.<br/>
/sysinfo.txt&#160;Инфо-страница&#160;о состояние&#160;устройства.<br/>
/set?параметр&#160;Установка&#160;параметров&#160;либо выполнение&#160;команд&#160;требующих&#160;доп&#160;авторизации<br/>
/set?reset_ro=пароль&#160;Сброс&#160;констант&#160;для&#160;датчиков&#160;газа<br/>/set?format=пароль&#160;Форматирование&#160;ФС&#160;устройства<br/>
/i2c_scan.txt&#160;Сканирование&#160;I2C&#160;шины&#160;МК&#160;и&#160;вывод&#160;адресов&#160;устройств&#160;на&#160;ней<br/>
/serial_in.txt&#160;Прямой&#160;запрос&#160;данных&#160;с&#160;микроконтроллера&#160;в&#160;протоколе&#160;A1&#160;DSP<br/>
/parse.txt&#160;Принудительный&#160;запрос&#160;и&#160; парсинг данных&#160;с&#160;МК<br/>
<hr/>
<a name=14></a><img src="LAB2-6_Report-14_1.jpg"/><br/>
DISP_ESP_SN<br/>
По&#160;сути&#160;изначально является&#160;устройством&#160;вывода&#160;информации,&#160;но по мере&#160;разработки&#160;ввиду&#160;<br/>достаточного&#160;количества&#160;незанятых&#160;контактов,&#160;было принято&#160;решение&#160;добавить&#160;возможность&#160;<br/>управления&#160;устройствами.<br/>
На&#160;данный&#160;момент&#160;разработан&#160;функционал&#160;для&#160;получения&#160;команд&#160;управления&#160;как с&#160;сайта&#160;народного&#160;<br/>мониторинга&#160;так и&#160;по средством&#160;get&#160;запросов&#160;и&#160;A1&#160;DSP&#160;протоколу.<br/>
Однако по умолчанию&#160;единственным&#160;управляемым&#160;значением&#160;является&#160;подсветка&#160;дисплея.<br/>
В&#160;основе&#160;своей&#160;код&#160;повторяет&#160;CH_ESP_SN&#160;только&#160;без&#160;МК,&#160;и&#160;с&#160;использованием&#160;функции&#160;парсинга&#160;ответа&#160;<br/>narodmon.<br/>
Также&#160;в&#160;устройство&#160;встроен&#160;собственный&#160;датчик&#160;температуры&#160;и&#160;влажности&#160;DHT-22&#160;данные&#160;с&#160;которого&#160;<br/>отображаются&#160;на&#160;экране&#160;и&#160;передаются&#160;на&#160;сервер,&#160;а&#160;также&#160;доступны&#160;по протоколам.<br/>
Графический&#160;интерфейс&#160;разрабатывался&#160;с&#160;учётом&#160;имеющегося&#160;оборудования&#160;и&#160;средств&#160;отображения.&#160;В<br/>виду&#160;этого&#160;он&#160;представляет&#160;две&#160;строки&#160;в&#160;первой&#160;статично обрисовывается&#160;текущее&#160;<br/>время(синхронизируется&#160;по&#160;NTP&#160;при&#160;запуске)&#160;и&#160;в&#160;крайне&#160;правом&#160;углу&#160;иконка&#160;мощности&#160;сигнала&#160;Wi-Fi.&#160; &#160;&#160;<br/>А&#160;во второй&#160;строке&#160;меняясь&#160;каждые&#160;20&#160;сек отображается&#160;информация&#160;полученная&#160;как с&#160;удалённых&#160;так&#160;<br/>и&#160;с&#160;локальных&#160;датчиков.<br/>
Для&#160;экономии&#160;портов&#160;ввода&#160;вывода&#160;дисплей&#160;был&#160;подключён&#160;через&#160;сдвиговый&#160;регистр&#160;M74HC595,&#160;для&#160;<br/>его работы&#160;на&#160;esp8266&#160;было произведено портирование&#160;библиотеки&#160;ShiftRegLCD123(Arduino)&#160;с&#160;учётом&#160;<br/>особенностей&#160;работы&#160;ОС&#160;реального времени(конкретно&#160;WDT)&#160;и&#160;взаимодействия&#160;с&#160;GPIO.&#160;Также&#160;была&#160;<br/>добавлена&#160;поддержка&#160;русского языка,&#160;посредством&#160;таблицы&#160;смещений(кодов&#160;символов).<br/>
<i>Внешний&#160;вид&#160;при&#160;использование&#160;знакогенерирующего&#160;ЖКИ&#160;MT-20S2M</i><br/>
<hr/>
<a name=15></a><img src="LAB2-6_Report-15_1.jpg"/><br/>
<i>Внешний&#160;вид&#160;прототипа&#160;DISP_ESP_SN</i><br/>
<hr/>
<a name=16></a><img src="LAB2-6_Report-16_1.jpg"/><br/>
Переделка&#160;FBI&#160;<br/>
Для&#160;отображения&#160;данных&#160;о&#160;текущей&#160;погоде&#160;(на&#160;данный&#160;момент)&#160;и&#160;других&#160;данных(в&#160;перспективе),&#160;было&#160;<br/>выбрано использование&#160;так называемого&#160;Linux&#160;Frame&#160;Buffer&#160;Device&#160;устройства&#160;ОС&#160;на&#160;базе&#160;ядра&#160;Linux.&#160;<br/>Ввиду&#160;возможности&#160;его использования&#160;на&#160;большом&#160;количестве&#160;устройств,&#160;как обычных&#160;ПК&#160;так и&#160;<br/>встраиваемой&#160;техники&#160;и&#160;мобильных&#160;устройствах,&#160;а&#160;также&#160;минимальным&#160;требованием&#160;по&#160;<br/>производительности&#160;системы&#160;и&#160;объёму&#160;ОЗУ.&#160;Сам&#160;по себе&#160;&#160;Linux&#160;Frame&#160;Buffer&#160;Device&#160;есть&#160;не&#160;что иное,&#160;как<br/>аппаратно независимый&#160;интерфейс&#160;для&#160;вывода&#160;и&#160;захвата&#160;изображения&#160;на&#160;экране.<br/>
Ввиду&#160;нецелесообразности&#160;разработки&#160;полностью&#160;собственного переложения&#160;для&#160;вывода&#160;данных&#160;<br/>было принято&#160;решение&#160;использовать&#160;как основу&#160;имеющееся&#160;приложение&#160;FBI&#160;(Linux&#160;framebuffer&#160;<br/>imageviewer).&#160;Информация&#160;была&#160;внедрена&#160;туда&#160;путём&#160;незначительной&#160;модификации&#160;кода,&#160;а&#160;именно&#160;<br/>заменой&#160;стандартной&#160;информационной&#160;строки&#160;на&#160;собственную&#160;формируемую&#160;на&#160;основе&#160;данных&#160;<br/>полученных&#160;по&#160;A1&#160;DSP,&#160;по&#160;средством&#160;libcurl,&#160;от&#160;назначенного устройства.&#160;Также&#160;стоит&#160;отметить&#160;удобный<br/>внутренний&#160;функционал&#160;отрисовки&#160;самой&#160;программы,&#160;который&#160;позволяет&#160;достаточно&#160;просто вывести&#160;<br/>любую&#160;информацию&#160;в&#160;любую&#160;область&#160;экрана.&#160;В&#160;дальнейшем&#160;планируется&#160;отделить&#160;код&#160;прорисовки&#160;<br/>информации&#160;от&#160;кода&#160;стандартной&#160;инфо строки,&#160;а&#160;также&#160;добавить&#160;ключи&#160;для&#160;управления&#160;этим.&#160;Также&#160;<br/>планируется&#160;разработка&#160;резидентной&#160;программы&#160;оболочки,&#160;для&#160;использования&#160;как прямой&#160;терминал&#160;<br/>управления&#160;умным&#160;домом.&#160;И&#160;отделения&#160;строки&#160;информации&#160;для&#160;включения&#160;и&#160;конфигурации&#160;<br/>отдельным&#160;ключом,&#160;а&#160;также&#160;добавления&#160;локального сокета&#160;для&#160;взаимодействия&#160;с&#160;другими&#160;<br/>программами.<br/>
<i>Пример&#160;экрана&#160;отображаемого&#160;пользователю</i><br/>
<hr/>
<a name=17></a><img src="LAB2-6_Report-17_1.png"/><br/>
Объединение&#160;CH_ESP_SN&#160;и&#160;DISP_ESP_SN<br/>
После&#160;разработки&#160;и&#160;запуска&#160;описанной&#160;выше&#160;системы&#160;стало понятно,&#160;что для&#160;устройств&#160;<br/>DISP_ESP_SN(отображения&#160;информации&#160;и&#160;управления)&#160;и&#160;CH_ESP_SN(устройства&#160;регистрации&#160;данных&#160;<br/>датчиков)&#160;можно создать&#160;унифицированную&#160;аппаратную&#160;платформу,&#160;из&#160;имеющихся&#160;на&#160;рынке&#160;<br/>компонентов.<br/>
Но ввиду&#160;недостатка&#160;времени&#160;работы&#160;по данному&#160;направлению&#160;не&#160;были&#160;закончены.<br/>
Ниже&#160;представлена&#160;незаконченная&#160;принципиальная&#160;схема.<br/>
<hr/>
</body>
</html>
